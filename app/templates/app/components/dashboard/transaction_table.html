<section
	 x-data="transactionsList()"
	 class="tx-card"
	 :class="{ 'is-dark': $store.app.isDarkTheme }"
>

	<!-- Header: filters + controls -->
	<header class="tx-card__header is-flex is-align-items-center is-justify-content-space-between">

		<!-- Left: search + category -->
		<div class="is-flex is-align-items-center" style="gap: 0.75rem;flex-grow: 1;">

			<!-- Search -->
			<div class="field is-expanded mb-0">
				<div class="control has-icons-left">
					<input
						 class="input is-small"
						 type="text"
						 placeholder="Search description or amount"
						 x-model="q"
						 @input="goToPage(1)"
					>
					<span class="icon is-small is-left">
					<i class="fas fa-search"></i>
				</span>
				</div>
			</div>


			<!-- Category dropdown -->
			<div class="field" id="category-dropdown">
				<div class="control">
					<div class="dropdown" x-data="{ open: false }" @click.away="open = false" :class="{'is-active': open}">
						<div class="dropdown-trigger">
							<!-- Button styled like an input -->
							<button
								 class="button is-small has-icons-right"
								 :class="{ 'is-focused': open }"
								 aria-haspopup="true"
								 aria-controls="category-dropdown-menu"
								 @click="open = !open"
							>
								<span x-text="lookupCategory(categoryFilter) || 'All categories'"></span>
								<span class="icon is-small is-right dropdown-icon"
								      :style="{ 'transform': open ? 'rotate(180deg)' : 'none' }">
            <i class="fas fa-angle-down " aria-hidden="true"></i>
          </span>
							</button>
						</div>

						<div class="dropdown-menu" id="category-dropdown-menu" role="menu">
							<div class="dropdown-content">
								<a
									 href="#"
									 class="dropdown-item is-size-7"
									 :class="{ 'is-active': categoryFilter === '' }"
									 @click.prevent="categoryFilter = ''; goToPage(1); open = false"
								>
									All categories
								</a>
								<template x-for="c in categories" :key="c.id">
									<a
										 href="#"
										 class="dropdown-item is-size-7"
										 :class="{ 'is-active': c.id === categoryFilter }"
										 @click.prevent="categoryFilter = c.id; goToPage(1); open = false"
										 x-text="c.name"
									></a>
								</template>
							</div>
						</div>
					</div>
				</div>
			</div>

		</div>

		<!-- Right: controls + pagination -->
		<div class="is-flex is-align-items-center" style="gap: 0.5rem;">
			<!-- Compact toggle -->
			<template x-if="!$store.app.isMobile">
				<button class="button is-small display-mode-button"
				        @click="$store.settings.isCompactMode = !$store.settings.isCompactMode"
				        x-text="$store.settings.isCompactMode ? 'Normal' : 'Compact'">
				</button>
			</template>


			<div class="field" id="pagesize-dropdown" style="margin-bottom: 0">
				<div class="control">
					<div class="dropdown" x-data="{ open: false }" @click.away="open = false" :class="{'is-active': open}">
						<div class="dropdown-trigger">
							<!-- Button styled like an input -->
							<button
								 class="button is-small has-icons-right"
								 :class="{ 'is-focused': open }"
								 aria-haspopup="true"
								 aria-controls="rowsperpage-dropdown-menu"
								 @click="open = !open"
								 style="justify-content: space-between; text-align: left; cursor: pointer;"
							>
								<span x-text="rowsPerPage"></span>
								<span class="icon is-small is-right dropdown-icon"
								      :style="{ 'transform': open ? 'rotate(180deg)' : 'none' }">
            <i class="fas fa-angle-down " aria-hidden="true"></i>
          </span>
							</button>
						</div>

						<div class="dropdown-menu" id="rowsperpage-dropdown-menu" role="menu">
							<div class="dropdown-content">
								<a href="#" class="dropdown-item is-size-7" :class="{ 'is-active': rowsPerPage === 6 }"
								   @click.prevent="rowsPerPage = 6; goToPage(1); open = false">6</a>
								<a href="#" class="dropdown-item is-size-7" :class="{ 'is-active': rowsPerPage === 8 }"
								   @click.prevent="rowsPerPage = 8; goToPage(1); open = false">8</a>
								<a href="#" class="dropdown-item is-size-7" :class="{ 'is-active': rowsPerPage === 12 }"
								   @click.prevent="rowsPerPage = 12; goToPage(1); open = false">12</a>
								<a href="#" class="dropdown-item is-size-7" :class="{ 'is-active': rowsPerPage === 18 }"
								   @click.prevent="rowsPerPage = 18; goToPage(1); open = false">18</a>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Pagination -->
			<nav class="pagination is-small" role="navigation" aria-label="pagination">
				<a class="pagination-previous" :class="{ 'is-disabled': currentPage <= 1 }" @click.prevent="prevPage()">Prev</a>
				<a class="pagination-next" :class="{ 'is-disabled': currentPage >= totalPages }" @click.prevent="nextPage()">Next</a>
				<ul class="pagination-list is-unselectable">
					<li><a class="pagination-link is-current" x-text="currentPage"></a></li>
					<li class="has-text-grey">/ <span x-text="totalPages"></span></li>
				</ul>
			</nav>
		</div>
	</header>


	<!-- Body: fixed-height container -->
	<div class="tx-card__body" :style="`height: ${computedContainerHeight}px;`">

		<!-- LOADING skeletons -->
		<template x-if="$store.app.isLoading">
			<div>
				<template x-for="n in rowsPerPage" :key="n">
					<div class="skeleton-row" :class="{ 'skeleton--compact': $store.settings.isCompactMode }">
						<div style="width:100px;flex:0 0 100px;">
							<div class="skeleton skeleton__rect" style="width:70%;height:12px;"></div>
						</div>
						<div style="flex:1 1 auto;">
							<div class="skeleton skeleton__rect" style="width:50%;height:14px;margin-bottom:8px;"></div>
							<div class="skeleton skeleton__rect" style="width:30%;height:12px;"></div>
						</div>
						<div style="width:120px;flex:0 0 120px;" class="skeleton skeleton__rect"></div>
						<div style="width:64px;flex:0 0 64px;" class="skeleton skeleton__rect"></div>
					</div>
				</template>
			</div>
		</template>

		<!-- Actual rows -->
		<template x-if="!$store.app.isLoading">
			<div>
				<template x-if="filteredCount === 0">
					<div class="tx-no-results">
						<div class="card" style="width:320px;">
							<div class="card-content">
								<p class="title is-6" style="margin-bottom:6px">No transactions</p>
								<p class="subtitle is-7" style="color:var(--tx-muted)">No transactions match the current filters.</p>
							</div>
						</div>
					</div>
				</template>

				<template x-for="(tx, idx) in paginated" :key="tx.id ?? idx">
					<div>
						<!-- Desktop -->
						<div class="tx-row" :class="{ 'tx-row--compact': $store.settings.isCompactMode }"
						     x-show="!$store.app.isMobile" aria-hidden="false">

							<!-- Left column: date (top) + description (bottom) -->
							<div class="tx-row__left">
								<div class="tx-row__date" x-text="formatDate(tx.date)"></div>
								<div class="tx-row__desc" x-text="tx.description || '—'"></div>
							</div>

							<!-- Right column: category (top) + amount (bottom) -->
							<div class="tx-row__right">
								<div class="tx-row__cat tag is-clickable is-unselectable" x-text="lookupCategory(tx.category_id)"
								     :style="`
                                --category-color: ${tx.category?.color || '#ccc'};
                                color: ${$store.app.isDarkTheme ? '#fff' : '#000'};
                                border: 1px solid ${tx.category?.color || '#888'};
                              `"
								     x-text="tx.category?.name || 'Uncategorized'"
								     @click="categoryFilter === tx.category?.id
                                ? clearFilters()
                                : categoryFilter = tx.category?.id
                               ">
								</div>
								<div class="tx-row__amount has-text-weight-semibold">
									<span :class="tx.is_income ? 'has-text-success' : 'has-text-danger'"
								     x-text="formatAmount(tx.amount, tx.currency || 'PLN') + ' PLN'"></span>
<!--									<span style="font-size: 0.9rem;"> PLN</span>-->
								</div>
							</div>
						</div>


						<!-- Mobile -->
						<div class="tx-mobile-card" :class="{ 'tx-mobile-card--compact': $store.settings.isCompactMode }"
						     x-show="$store.app.isMobile" style="display:block;">
							<div class="tx-mb-row">
								<div class="tx-mb-left">
									<span class="tx-mb-date" x-text="formatDate(tx.date)"></span>
									<span class="tx-mb-desc" x-text="tx.description || '—'"></span>
								</div>
								<div class="tx-mb-right">
									<div class="tx-mb-cat tag is-clickable is-unselectable" x-text="lookupCategory(tx.category_id)"
									     :style="`
                                --category-color: ${tx.category?.color || '#ccc'};
                                color: ${$store.app.isDarkTheme ? '#fff' : '#000'};
                                border: 1px solid ${tx.category?.color || '#888'};
                              `"
									     x-text="tx.category?.name || 'Uncategorized'"
									     @click="categoryFilter === tx.category?.id
                                ? clearFilters()
                                : categoryFilter = tx.category?.id
                               ">
									</div>

									<div class="tx-mb-amount has-text-weight-semibold">
										<span :class="tx.is_income ? 'has-text-success' : 'has-text-danger'"
								     x-text="formatAmount(tx.amount, tx.currency || 'PLN') + ' PLN'"></span>
<!--									<span style="font-size: 0.8rem;"> PLN</span>-->
									</div>
								</div>
							</div>
						</div>

					</div>
				</template>

			</div>
		</template>

	</div>
</section>